name: Check Bazel Tests

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
     fail-fast: false
     matrix:
        include:
          - test: "//base/javacontainer/test:ExaStackTraceCleanerTest"
            name: "ExaStackTraceCleanerTest"
          - test: "//base/javacontainer/test:javacontainer-test-legacy-parser"
            name: "javacontainer-test-legacy-parser"
          - test: "//base/javacontainer/test:javacontainer-test-ctpg-parser"
            name: "javacontainer-test-ctpg-parser"
          - test: "//base/javacontainer/script_options/..."
            name: "javacontainer-script_options"
          - test: "//base/exaudflib/test/..."
            name: "exaudflib"
          - test: "//base/script_options_parser/ctpg/..."
            name: "script_options_parser_ctpg"
          - test: "//base/script_options_parser/legacy/..."
            name: "script_options_parser_legacy"
          - test: "--run_under='valgrind' --copt -DVALGRIND_ACTIVE //base/javacontainer/test:javacontainer-test-legacy-parser"
            name: "javacontainer-test-legacy-parser-with-valgrind"
          - test: "--run_under='valgrind' --copt -DVALGRIND_ACTIVE //base/javacontainer/test:javacontainer-test-ctpg-parser"
            name: "javacontainer-test-ctpg-parser-with-valgrind"
          - test: "--run_under='valgrind' --copt -DVALGRIND_ACTIVE //base/script_options_parser/ctpg/..."
            name: "script_options_parser_ctpg_with_valgrind"
          - test: "--run_under='valgrind' --copt -DVALGRIND_ACTIVE //base/script_options_parser/legacy/..."
            name: "script_options_parser_legacy_with_valgrind"
          - test: "--config=asan //base/javacontainer/test:javacontainer-test-legacy-parser"
            name: "javacontainer-test-legacy-parser-with-asan"
          - test: "--config=asan //base/javacontainer/test:javacontainer-test-ctpg-parser"
            name: "javacontainer-test-ctpg-parser-with-asan"
          - test: "--config=asan //base/script_options_parser/ctpg/..."
            name: "script_options_parser_ctpg_with_asan"
          - test: "--config=asan //base/script_options_parser/legacy/..."
            name: "script_options_parser_legacy_with_asan"


    env:
      USE_BAZEL_VERSION: 7.2.1
    steps:
    - uses: actions/checkout@v4
    - name: Search for duplicated error codes
      run: bash find_duplicate_error_codes.sh

    - name: Install bazel
      run: | 
        curl -L -o bazel https://github.com/bazelbuild/bazelisk/releases/download/v1.19.0/bazelisk-linux-amd64
        chmod +x bazel
    - name: Install JDK and ZMQ
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-11-jdk libzmq3-dev valgrind
    - name: Run tests
      run: |
        bazel test ${{ matrix.additional_args }} ${{ matrix.test }}
      working-directory: ./exaudfclient/

    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: "${{ matrix.name }}"
        path: /home/runner/.cache/bazel/_bazel_runner/*/execroot/_main/bazel-out/k8-dbg/testlogs/**/test.log
