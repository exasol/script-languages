# ---- AUTOMATICALLY GENERATED FILE ----
# ---- DO NOT EDIT MANUALLY, BUT USE PYTHON MODULE "exasol.slc_ci_setup" ----
# ---- from https://github.com/exasol/script-languages-container-ci-setup TO UPDATE ----


name: SLC-CI-Prepare-Test-Container

on:
  workflow_call:
    secrets:
      CI4_DOCKERHUB_USERNAME:
        required: true
      CI4_DOCKERHUB_TOKEN:
        required: true
jobs:
  prepare-test-container:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Setup Python & Poetry Environment
        uses: exasol/python-toolbox/.github/actions/python-environment@v5
        with:
          python-version: "3.10"
          poetry-version: "2.3.0"

      - name: Prepare test container
        run: |
            echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
            poetry run -- exaslc-ci prepare-test-container --commit-sha "$COMMIT_SHA" --docker-user "$DOCKER_USERNAME" --docker-password "$DOCKER_PASSWORD"
        env:
          DOCKER_USERNAME: ${{ secrets.CI4_DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.CI4_DOCKERHUB_TOKEN }}
          COMMIT_SHA: ${{ github.sha }}

      - name: Check for password
        run: grep -rq ${{ secrets.CI4_DOCKERHUB_TOKEN }} .build_output && exit 1 || exit 0

      - uses: actions/upload-artifact@v6
        if: ${{ always() }}
        name: Upload log artifacts
        with:
          name: logs_prepare_test_container
          path: |
            .build_output/jobs/**/*
            .build_output/meta_data/**/*
          retention-days: 30
