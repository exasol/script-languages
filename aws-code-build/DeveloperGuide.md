## Local Run

AWS Code Build provides docker containers and a small script to run single builds locally.
Note: This does not work for batch builds, only single builds.
Another limitation is, that artifacts will not be uploaded to S3.

### Requirements
- Docker
- AWS CLI setup
- GIT


### Setup

[Here](https://docs.aws.amazon.com/codebuild/latest/userguide/use-codebuild-agent.html) are detailed scripts for the installation.

There are two options:
1. Build the AWS build container from scratch which might take several hours. You can use the script [get_from_source.sh](run_local/get_from_source.sh) which runs the installation automatically.
2. Use the prebuilt AWS build container from Dockerhub in the `exadockerci4/aws_codebuild` repository (which might not be up-tp-date). You can use the script [get_prebuilt.sh](run_local/get_prebuilt.sh) which runs the installation automatically.

### Run

- Set the flavor in `aws-code-build/run_local/run_local.env`
- Run [run_local.sh](run_local/run_local.sh) or [run_local_prebuilt.sh](run_local/run_local_prebuilt.sh) with buildspec file and AWS profile as parameters:

```bash
bash ./aws-code-build/run_local/run_local.sh aws-code-build/ci/build_buildspec.yaml my_aws_profile_mfa
```

## Buildspec Updates

The buildspec files are automatically generated by `script-languages-container-ci-setup`. There is a [githook](../githooks/update_aws_buildspec.sh) which ensures that the buildspecs are up-to-date.

## AWS Deployment

The infrastructure is created using AWS Cloudformation. The cloudformation stack can be automatically deployed by using the script [update_aws_build_stack.sh](update_aws_build_stack.sh). You need to pass your AWS profile as parameter, for example:

```bash
bash ./aws-code-build/update_aws_build_stack.sh my-aws-profile-mfa
```

## AWS Build Overview

- AWS CodeBuild has registered a WebHook in [script-languages](https://github.com/exasol/script-languages) and [script-languages-release](https://github.com/exasol/script-languages-release), which will trigger AWS builds automatically
- Access the AWS Console and go to "CodeBuild"
- On the left side select Build -> Build projects 
- Select the SLCCodeBuild_... or SLCReleaseCodeBuild_... project
- In the tag select "Batch History", there you will see all started batch builds for a commit.
- Select a batch build, and you can see all single builds (for each flavor) which belong to the batch build
